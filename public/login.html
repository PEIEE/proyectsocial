<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesión / Registrarse</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h2>Iniciar Sesión o Registrarse</h2>
        <form id="auth-form">
            <div>
                <label for="username">Nombre de usuario</label>
                <input type="text" id="username" required>
            </div>
            <div>
                <label for="email">Correo</label>
                <input type="email" id="email" required>
            </div>
            <div>
                <label for="password">Contraseña</label>
                <input type="password" id="password" required minlength="6">
            </div>
            <button type="button" id="register-btn">Registrarse</button>
            <button type="button" id="login-btn" style="display: none;">Iniciar Sesión</button>
            <p id="error-message" style="color: red;"></p>
            <p id="loading-message" style="color: blue; display: none;">Procesando...</p>
        </form>
        <p id="toggle-text">
            ¿Ya tienes cuenta? <a href="#" id="toggle-register">Inicia sesión</a>
        </p>
    </div>

    <script type="module">
        import { loginUser, registerUser } from '../src/auth.js';

        const authForm = document.getElementById('auth-form');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const errorMessage = document.getElementById('error-message');
        const loadingMessage = document.getElementById('loading-message');
        const toggleRegister = document.getElementById('toggle-register');
        const usernameInput = document.getElementById('username');
        const usernameLabel = document.querySelector('label[for="username"]');
        const toggleText = document.getElementById('toggle-text');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');

        let isRegisterMode = true;

        // Alternar entre registro e inicio de sesión
        toggleRegister.addEventListener('click', (e) => {
            e.preventDefault();
            isRegisterMode = !isRegisterMode;
            usernameInput.style.display = isRegisterMode ? 'block' : 'none';
            usernameLabel.style.display = isRegisterMode ? 'block' : 'none';
            loginBtn.style.display = isRegisterMode ? 'none' : 'block';
            registerBtn.style.display = isRegisterMode ? 'block' : 'none';
            toggleText.innerHTML = isRegisterMode
                ? '¿Ya tienes cuenta? <a href="#" id="toggle-register">Inicia sesión</a>'
                : '¿No tienes cuenta? <a href="#" id="toggle-register">Regístrate</a>';
            errorMessage.textContent = '';
            loadingMessage.style.display = 'none';
        });

        // Iniciar sesión
        loginBtn.addEventListener('click', async () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                errorMessage.textContent = 'Por favor, completa todos los campos.';
                return;
            }

            errorMessage.textContent = '';
            loadingMessage.style.display = 'block';

            try {
                await loginUser(email, password);
                window.location.href = '/chat.html';
            } catch (error) {
                loadingMessage.style.display = 'none';
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage.textContent = 'Correo no registrado.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage.textContent = 'Contraseña incorrecta.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage.textContent = 'Correo inválido.';
                        break;
                    case 'auth/invalid-credential':
                        errorMessage.textContent = 'Credenciales inválidas.';
                        break;
                    default:
                        errorMessage.textContent = `Error: ${error.message}`;
                }
            }
        });

        // Registrarse
        registerBtn.addEventListener('click', async () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            const username = usernameInput.value.trim();

            if (!email || !password || !username) {
                errorMessage.textContent = 'Por favor, completa todos los campos.';
                return;
            }

            if (password.length < 6) {
                errorMessage.textContent = 'La contraseña debe tener al menos 6 caracteres.';
                return;
            }

            errorMessage.textContent = '';
            loadingMessage.style.display = 'block';

            try {
                await registerUser(email, password, username);
                window.location.href = '/chat.html';
            } catch (error) {
                loadingMessage.style.display = 'none';
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage.textContent = 'El correo ya está registrado.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage.textContent = 'Correo inválido.';
                        break;
                    case 'auth/weak-password':
                        errorMessage.textContent = 'La contraseña es demasiado débil.';
                        break;
                    default:
                        errorMessage.textContent = `Error: ${error.message}`;
                }
            }
        });

        // Permitir login con Enter
        authForm.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (isRegisterMode) {
                    registerBtn.click();
                } else {
                    loginBtn.click();
                }
            }
        });
    </script>
</body>
</html>
