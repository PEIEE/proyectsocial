<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesión / Registrarse</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container">
        <h2>Iniciar Sesión o Registrarse</h2>
        <form id="auth-form">
            <div>
                <label for="username">Nombre de usuario</label>
                <input type="text" id="username" required>
            </div>
            <div>
                <label for="email">Correo</label>
                <input type="email" id="email" required>
            </div>
            <div>
                <label for="password">Contraseña</label>
                <input type="password" id="password" required minlength="6">
            </div>
            <button type="button" id="register-btn">Registrarse</button>
            <button type="button" id="login-btn" style="display: none;">Iniciar Sesión</button>
            <p id="error-message" style="color: red;"></p>
            <p id="success-message" style="color: green; display: none;"></p>
            <p id="loading-message" style="color: blue; display: none;">Procesando...</p>
        </form>
        <p id="toggle-text">
            ¿Ya tienes cuenta? <a href="#" id="toggle-register">Inicia sesión</a>
        </p>
    </div>

    <script type="module">
        import { loginUser, registerUser } from '/auth.js';

        const authForm = document.getElementById('auth-form');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');
        const loadingMessage = document.getElementById('loading-message');
        const toggleRegister = document.getElementById('toggle-register');
        const usernameInput = document.getElementById('username');
        const usernameLabel = document.querySelector('label[for="username"]');
        const toggleText = document.getElementById('toggle-text');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');

        let isRegisterMode = true;

        // Función para alternar al modo de inicio de sesión
        function switchToLoginMode() {
            console.log('Cambiando a modo de inicio de sesión');
            isRegisterMode = false;
            usernameInput.style.display = 'none';
            usernameLabel.style.display = 'none';
            loginBtn.style.display = 'block';
            registerBtn.style.display = 'none';
            toggleText.innerHTML = '¿No tienes cuenta? <a href="#" id="toggle-register">Regístrate</a>';
            toggleRegister.removeEventListener('click', switchToLoginMode);
            toggleRegister.addEventListener('click', toggleMode);
        }

        // Función para alternar al modo de registro
        function switchToRegisterMode() {
            console.log('Cambiando a modo de registro');
            isRegisterMode = true;
            usernameInput.style.display = 'block';
            usernameLabel.style.display = 'block';
            loginBtn.style.display = 'none';
            registerBtn.style.display = 'block';
            toggleText.innerHTML = '¿Ya tienes cuenta? <a href="#" id="toggle-register">Inicia sesión</a>';
            toggleRegister.removeEventListener('click', switchToRegisterMode);
            toggleRegister.addEventListener('click', toggleMode);
        }

        // Función para alternar entre modos
        function toggleMode(e) {
            e.preventDefault();
            if (isRegisterMode) {
                switchToLoginMode();
            } else {
                switchToRegisterMode();
            }
            errorMessage.textContent = '';
            successMessage.style.display = 'none';
            loadingMessage.style.display = 'none';
        }

        // Configurar el listener inicial
        toggleRegister.addEventListener('click', toggleMode);

        // Iniciar sesión
        loginBtn.addEventListener('click', async () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                errorMessage.textContent = 'Por favor, completa todos los campos.';
                console.error('Campos vacíos detectados');
                return;
            }

            errorMessage.textContent = '';
            successMessage.style.display = 'none';
            loadingMessage.style.display = 'block';

            try {
                console.log('Intentando iniciar sesión con:', email);
                await loginUser(email, password);
                console.log('Inicio de sesión exitoso, redirigiendo a chat.html');
                window.location.href = '/chat.html';
            } catch (error) {
                loadingMessage.style.display = 'none';
                console.error('Error en inicio de sesión:', error.code, error.message);
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage.textContent = 'Correo no registrado.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage.textContent = 'Contraseña incorrecta.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage.textContent = 'Correo inválido.';
                        break;
                    case 'auth/invalid-credential':
                        errorMessage.textContent = 'Credenciales inválidas.';
                        break;
                    default:
                        errorMessage.textContent = `Error: ${error.message}`;
                }
            }
        });

        // Registrarse
        registerBtn.addEventListener('click', async () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            const username = usernameInput.value.trim();

            if (!email || !password || !username) {
                errorMessage.textContent = 'Por favor, completa todos los campos.';
                console.error('Campos vacíos detectados durante registro');
                return;
            }

            if (password.length < 6) {
                errorMessage.textContent = 'La contraseña debe tener al menos 6 caracteres.';
                console.error('Contraseña demasiado corta');
                return;
            }

            errorMessage.textContent = '';
            successMessage.style.display = 'none';
            loadingMessage.style.display = 'block';

            try {
                console.log('Intentando registrar con:', email, username);
                await registerUser(email, password, username);
                console.log('Registro exitoso, cambiando a modo de inicio de sesión');
                loadingMessage.style.display = 'none';
                successMessage.textContent = 'Registro exitoso, por favor inicia sesión.';
                successMessage.style.display = 'block';
                passwordInput.value = ''; // Limpiar contraseña por seguridad
                switchToLoginMode();
            } catch (error) {
                loadingMessage.style.display = 'none';
                console.error('Error en registro:', error.code, error.message);
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage.textContent = 'El correo ya está registrado.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage.textContent = 'Correo inválido.';
                        break;
                    case 'auth/weak-password':
                        errorMessage.textContent = 'La contraseña es demasiado débil.';
                        break;
                    case 'auth/permission-denied':
                        errorMessage.textContent = 'Permiso denegado al escribir datos de usuario.';
                        break;
                    default:
                        errorMessage.textContent = `Error: ${error.message}`;
                }
            }
        });

        // Permitir enviar formulario con Enter
        authForm.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (isRegisterMode) {
                    registerBtn.click();
                } else {
                    loginBtn.click();
                }
            }
        });
    </script>
</body>
</html>
